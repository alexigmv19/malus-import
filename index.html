
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Simulateur Malus API</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    h1 { text-align: center; }
    label, select, input, button { display: block; width: 90%; margin: 10px auto; padding: 10px; font-size: 16px; }
    #resultat { margin-top: 20px; text-align: center; font-size: 18px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Simulateur Malus FR (API simulée)</h1>
  <label>Marque :</label>
  <select id="marque" onchange="updateModeles()">
    <option value="">-- Choisir --</option>
    <option value="Peugeot">Peugeot</option>
    <option value="Renault">Renault</option>
    <option value="Volkswagen">Volkswagen</option>
  </select>

  <label>Modèle :</label>
  <select id="modele" onchange="updateVersions()"></select>

  <label>Version :</label>
  <select id="version"></select>

  <label>Année de mise en circulation :</label>
  <input type="number" id="annee" min="1990" max="2024" placeholder="Ex: 2021">

  <button onclick="lancerSimulation()">Calculer le Malus</button>

  <div id="resultat">Remplissez les champs ci-dessus</div>

  <script>
    const data = {
      "Peugeot": {
        "208": {
          "PureTech 100": { co2: 118, poids: 1120 },
          "e-208": { co2: 0, poids: 1455 }
        },
        "3008": {
          "Hybride 225": { co2: 32, poids: 1710 },
          "BlueHDi 130": { co2: 140, poids: 1500 }
        }
      },
      "Renault": {
        "Clio": {
          "TCe 90": { co2: 122, poids: 1130 },
          "E-Tech Hybrid": { co2: 96, poids: 1290 }
        },
        "Megane": {
          "Blue dCi 115": { co2: 134, poids: 1370 },
          "E-Tech Plug-in": { co2: 30, poids: 1650 }
        }
      },
      "Volkswagen": {
        "Golf": {
          "1.5 TSI": { co2: 129, poids: 1250 },
          "GTE Hybride": { co2: 36, poids: 1610 }
        },
        "ID.3": {
          "Pro Performance": { co2: 0, poids: 1780 }
        }
      }
    };

    function updateModeles() {
      const marque = document.getElementById("marque").value;
      const modeleSel = document.getElementById("modele");
      modeleSel.innerHTML = "";
      if (!data[marque]) return;
      Object.keys(data[marque]).forEach(modele => {
        modeleSel.innerHTML += `<option value="${modele}">${modele}</option>`;
      });
      updateVersions();
    }

    function updateVersions() {
      const marque = document.getElementById("marque").value;
      const modele = document.getElementById("modele").value;
      const versionSel = document.getElementById("version");
      versionSel.innerHTML = "";
      if (!data[marque] || !data[marque][modele]) return;
      Object.keys(data[marque][modele]).forEach(v => {
        versionSel.innerHTML += `<option value="${v}">${v}</option>`;
      });
    }

    function getDecote(mois) {
      if (mois >= 181) return 1;
      return Math.min((Math.floor((mois - 1) / 3) + 1) * 0.03, 0.94);
    }

    function calculMalusCO2(co2) {
      if (co2 <= 113) return 0;
      if (co2 >= 192) return 70000;
      return 50 + (co2 - 113) * 30;
    }

    function calculMalusPoids(poids) {
      if (poids <= 1599) return 0;
      let malus = 0, exc = poids - 1599;
      const tranches = [
        { max: 200, val: 10 },
        { max: 100, val: 15 },
        { max: 100, val: 20 },
        { max: 100, val: 25 },
        { max: Infinity, val: 30 }
      ];
      for (let t of tranches) {
        let used = Math.min(exc, t.max);
        malus += used * t.val;
        exc -= used;
        if (exc <= 0) break;
      }
      return malus;
    }

    function lancerSimulation() {
      const marque = document.getElementById("marque").value;
      const modele = document.getElementById("modele").value;
      const version = document.getElementById("version").value;
      const annee = parseInt(document.getElementById("annee").value);
      const vehicule = data[marque]?.[modele]?.[version];
      if (!vehicule || isNaN(annee)) {
        document.getElementById("resultat").innerText = "Veuillez remplir tous les champs.";
        return;
      }

      const co2 = vehicule.co2;
      const poids = vehicule.poids;
      const date = new Date(annee, 0, 1);
      const now = new Date();
      const mois = (now.getFullYear() - date.getFullYear()) * 12 + now.getMonth() - date.getMonth();
      const decote = getDecote(mois);
      const malusCO2 = calculMalusCO2(co2);
      const malusPoids = calculMalusPoids(poids);
      const total = Math.min(malusCO2 + malusPoids, 70000);
      const totalDecote = Math.round(total * (1 - decote));

      document.getElementById("resultat").innerText =
        `CO₂ : ${co2} g/km\nPoids : ${poids} kg\nMalus CO₂ : ${malusCO2} €\nMalus Poids : ${malusPoids} €\nDécote : ${Math.round(decote * 100)}%\n\nTotal à payer : ${totalDecote} €`;
    }

    window.onload = updateModeles;
  </script>
</body>
</html>
