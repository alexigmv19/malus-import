
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Malus FR - Versions & Motorisations</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background-color: #f0f0f0; padding: 20px; }
    .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    label, select, input, button { display: block; width: 100%; margin-top: 10px; padding: 10px; font-size: 16px; }
    button { background: #007bff; color: white; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }
    #resultat { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Malus Import FR (avec motorisation)</h2>
    <label>Marque :</label>
    <input id="make" placeholder="ex: Peugeot" />

    <label>Modèle :</label>
    <input id="model" placeholder="ex: 208" />

    <label>Année :</label>
    <input type="number" id="year" placeholder="ex: 2022" />

    <button onclick="getVersions()">Rechercher les versions</button>

    <label for="version">Versions trouvées :</label>
    <select id="version"></select>

    <button onclick="calculerMalus()">Calculer le Malus</button>

    <div id="resultat">Résultat affiché ici</div>
  </div>

  <script>
    let carList = [];

    async function getVersions() {
      const make = document.getElementById("make").value;
      const model = document.getElementById("model").value;
      const year = document.getElementById("year").value;
      const versionSelect = document.getElementById("version");
      const result = document.getElementById("resultat");

      versionSelect.innerHTML = "";
      result.textContent = "Chargement des versions...";

      try {
        const response = await fetch(`https://cars-by-api-ninjas.p.rapidapi.com/v1/cars?make=${make}&model=${model}&year=${year}`, {
          method: 'GET',
          headers: {
            'x-rapidapi-host': 'cars-by-api-ninjas.p.rapidapi.com',
            'x-rapidapi-key': 'cefca16aabmshccf66bfe3d6c9e1p136c9ejsn2228d3ef985e'
          }
        });

        const data = await response.json();
        carList = data;

        if (!data || data.length === 0) {
          result.textContent = "Aucune version trouvée.";
          return;
        }

        result.textContent = `Versions trouvées : ${data.length}`;
        data.forEach((v, index) => {
          const opt = document.createElement("option");
          opt.value = index;
          opt.textContent = `${v.trim} - ${v.fuel_type} - ${v.transmission} - ${v.displacement}L`;
          versionSelect.appendChild(opt);
        });
      } catch (error) {
        result.textContent = "Erreur lors de la récupération des données.";
        console.error(error);
      }
    }

    function calculerMalus() {
      const index = document.getElementById("version").value;
      const result = document.getElementById("resultat");

      if (!carList[index]) {
        result.textContent = "Veuillez d'abord choisir une version.";
        return;
      }

      const car = carList[index];
      const poids = car.weight || 1500;
      const mpg = car.city_mpg;
      const co2 = mpg ? Math.round(235 / mpg) : null;

      let malus_co2 = 0;
      if (co2 && co2 >= 118) {
        if (co2 >= 193) malus_co2 = 60000;
        else malus_co2 = 50 + (co2 - 118) * 30;
      }

      let malus_poids = 0;
      if (poids > 1600) {
        const exc = poids - 1600;
        malus_poids = exc * 10;
      }

      let total = malus_co2 + malus_poids;
      if (total > 60000) total = 60000;

      result.innerHTML = `
        <strong>Détails sélectionnés :</strong><br>
        Motorisation : ${car.fuel_type}<br>
        Transmission : ${car.transmission}<br>
        Cylindrée : ${car.displacement}L<br>
        Poids : ${poids} kg<br>
        CO₂ estimé : ${co2 ? co2 + " g/km" : "non dispo"}<br><br>
        Malus CO₂ : ${malus_co2.toLocaleString()} €<br>
        Malus poids : ${malus_poids.toLocaleString()} €<br>
        <strong>Total estimé : ${total.toLocaleString()} €</strong>
      `;
    }
  </script>
</body>
</html>
