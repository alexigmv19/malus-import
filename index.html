
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Simulateur Malus 2025 - Sélection dynamique</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: Arial, sans-serif; background: #f1f1f1; padding: 20px; }
    .container { max-width: 500px; margin: auto; background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    label, select, input, button { display: block; width: 100%; margin-top: 10px; padding: 10px; font-size: 16px; border-radius: 5px; }
    button { background-color: #007bff; color: #fff; border: none; margin-top: 20px; cursor: pointer; }
    button:hover { background-color: #0056b3; }
    #result { margin-top: 20px; text-align: center; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Simulateur Malus Import - 2025</h2>

    <label for="make">Marque :</label>
    <select id="make"><option>Chargement...</option></select>

    <label for="model">Modèle :</label>
    <select id="model"><option>Sélectionnez une marque</option></select>

    <label for="year">Année :</label>
    <input type="number" id="year" placeholder="ex: 2021" min="2000" max="2025" />

    <label for="month">Mois :</label>
    <select id="month">
      ${[...Array(12).keys()].map(m => `<option value="${m+1}">${new Date(0, m).toLocaleString('fr-FR', { month: 'long' })}</option>`).join("")}
    </select>

    <button onclick="getCarData()">Calculer le Malus</button>
    <div id="result">Résultat affiché ici</div>
  </div>

  <script>
    const makeSelect = document.getElementById("make");
    const modelSelect = document.getElementById("model");
    const resultDiv = document.getElementById("result");

    let allCars = [];

    async function fetchAllCars() {
      const response = await fetch("https://cars-by-api-ninjas.p.rapidapi.com/v1/cars?limit=100", {
        method: "GET",
        headers: {
          "x-rapidapi-host": "cars-by-api-ninjas.p.rapidapi.com",
          "x-rapidapi-key": "cefca16aabmshccf66bfe3d6c9e1p136c9ejsn2228d3ef985e"
        }
      });
      const data = await response.json();
      allCars = data;
      const makes = [...new Set(data.map(car => car.make))].sort();
      makeSelect.innerHTML = '<option value="">Sélectionnez une marque</option>';
      makes.forEach(make => {
        const opt = document.createElement("option");
        opt.value = make;
        opt.textContent = make;
        makeSelect.appendChild(opt);
      });
    }

    makeSelect.addEventListener("change", () => {
      const selectedMake = makeSelect.value;
      const models = [...new Set(allCars.filter(c => c.make === selectedMake).map(c => c.model))].sort();
      modelSelect.innerHTML = '<option value="">Sélectionnez un modèle</option>';
      models.forEach(model => {
        const opt = document.createElement("option");
        opt.value = model;
        opt.textContent = model;
        modelSelect.appendChild(opt);
      });
    });

    async function getCarData() {
      const make = makeSelect.value;
      const model = modelSelect.value;
      const year = parseInt(document.getElementById("year").value);
      const month = parseInt(document.getElementById("month").value);

      if (!make || !model || !year || !month) {
        resultDiv.innerText = "Veuillez remplir tous les champs.";
        return;
      }

      const response = await fetch(`https://cars-by-api-ninjas.p.rapidapi.com/v1/cars?make=${make}&model=${model}&year=${year}`, {
        method: "GET",
        headers: {
          "x-rapidapi-host": "cars-by-api-ninjas.p.rapidapi.com",
          "x-rapidapi-key": "cefca16aabmshccf66bfe3d6c9e1p136c9ejsn2228d3ef985e"
        }
      });

      const data = await response.json();
      const car = data[0];
      if (!car) {
        resultDiv.innerText = "Aucune donnée trouvée.";
        return;
      }

      const mpg = car.city_mpg;
      const weight = car.weight || 1400;
      const co2 = mpg ? Math.round(235 / mpg) : 0;
      const malus_co2 = co2 >= 118 ? (co2 >= 193 ? 60000 : 50 + (co2 - 118) * 30) : 0;
      const malus_poids = weight > 1600 ? (weight - 1600) * 10 : 0;
      const total = Math.min(malus_co2 + malus_poids, 60000);

      const now = new Date();
      const immat = new Date(year, month - 1);
      const moisDiff = (now.getFullYear() - immat.getFullYear()) * 12 + (now.getMonth() - immat.getMonth());
      const decote = Math.min(Math.floor(moisDiff / 3 + 1) * 0.03, 0.94);
      const totalFinal = Math.round(total * (1 - decote));

      resultDiv.innerHTML = `
        CO₂ estimé : ${co2} g/km<br>
        Poids estimé : ${weight} kg<br>
        Malus CO₂ : ${malus_co2.toLocaleString()} €<br>
        Malus poids : ${malus_poids.toLocaleString()} €<br>
        Décote : ${Math.round(decote * 100)}%<br>
        <strong>Total à payer : ${totalFinal.toLocaleString()} €</strong>
      `;
    }

    fetchAllCars();
  </script>
</body>
</html>
