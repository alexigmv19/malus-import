
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Malus FR (API connectée)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
    h1 { text-align: center; }
    label, select, input, button { display: block; width: 90%; margin: 10px auto; padding: 10px; font-size: 16px; }
    #resultat { margin-top: 20px; text-align: center; font-size: 18px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Simulateur Malus Import FR (API)</h1>

  <label>Marque :</label>
  <select id="marque"></select>

  <label>Modèle :</label>
  <select id="modele"></select>

  <label>Version :</label>
  <select id="version"></select>

  <label>Année de mise en circulation :</label>
  <input type="number" id="annee" min="2000" max="2024" placeholder="Ex: 2021">

  <button onclick="fetchDataAndCalculate()">Calculer le Malus</button>
  <div id="resultat">Chargement de l'API...</div>

  <script>
    const API_KEY = "7|78K93fqqA0iT0DUL7v6IWMa9LEXxW5u3CKDFVtCb";
    const API_HOST = "https://www.planete-moteurs.fr"; // à adapter selon la doc officielle

    async function init() {
      const marques = await fetch(API_HOST + "/api/v1/marques", {
        headers: { "Authorization": "Bearer " + API_KEY }
      }).then(r => r.json());

      const select = document.getElementById("marque");
      marques.forEach(m => {
        const option = document.createElement("option");
        option.value = m.id || m.nom;
        option.text = m.nom || m;
        select.appendChild(option);
      });

      select.addEventListener("change", async () => {
        const id = select.value;
        const modeles = await fetch(API_HOST + `/api/v1/marques/${id}/modeles`, {
          headers: { "Authorization": "Bearer " + API_KEY }
        }).then(r => r.json());

        const modeleSel = document.getElementById("modele");
        modeleSel.innerHTML = "";
        modeles.forEach(m => {
          const opt = document.createElement("option");
          opt.value = m.id || m.nom;
          opt.text = m.nom || m;
          modeleSel.appendChild(opt);
        });

        modeleSel.dispatchEvent(new Event("change"));
      });

      document.getElementById("modele").addEventListener("change", async () => {
        const marqueId = document.getElementById("marque").value;
        const modeleId = document.getElementById("modele").value;
        const versions = await fetch(API_HOST + `/api/v1/modeles/${modeleId}/versions`, {
          headers: { "Authorization": "Bearer " + API_KEY }
        }).then(r => r.json());

        const versionSel = document.getElementById("version");
        versionSel.innerHTML = "";
        versions.forEach(v => {
          const opt = document.createElement("option");
          opt.value = v.id || v.nom;
          opt.text = v.nom || v;
          versionSel.appendChild(opt);
        });
      });
    }

    async function fetchDataAndCalculate() {
      const versionId = document.getElementById("version").value;
      const annee = parseInt(document.getElementById("annee").value);
      const response = await fetch(API_HOST + `/api/v1/versions/${versionId}`, {
        headers: { "Authorization": "Bearer " + API_KEY }
      });

      const data = await response.json();
      const co2 = data.co2 || 0;
      const poids = data.poids || 1500;

      const mois = (new Date().getFullYear() - annee) * 12;
      const decote = mois >= 181 ? 1 : Math.min(Math.floor((mois - 1) / 3 + 1) * 0.03, 0.94);

      let malusCO2 = co2 <= 113 ? 0 : co2 >= 192 ? 70000 : 50 + (co2 - 113) * 30;
      let exc = poids - 1599, malusPoids = 0;
      const tranches = [ [200,10], [100,15], [100,20], [100,25], [Infinity,30] ];
      for (let [max, val] of tranches) {
        let used = Math.min(exc, max);
        malusPoids += used * val;
        exc -= used;
        if (exc <= 0) break;
      }

      const total = Math.min(malusCO2 + malusPoids, 70000);
      const totalDecote = Math.round(total * (1 - decote));

      document.getElementById("resultat").innerText =
        `CO₂ : ${co2} g/km\nPoids : ${poids} kg\nMalus CO₂ : ${malusCO2} €\nMalus Poids : ${malusPoids} €\nDécote : ${Math.round(decote * 100)}%\n\nTotal à payer : ${totalDecote} €`;
    }

    init();
  </script>
</body>
</html>
